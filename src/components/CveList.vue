<template>
  <div id="cve-list-view" v-if='isUpdating'>
    <div class='loader-container'>
      <div class="loader">
      <div class="square" ></div>
      <div class="square"></div>
      <div class="square last"></div>
      <div class="square clear"></div>
      <div class="square"></div>
      <div class="square last"></div>
      <div class="square clear"></div>
      <div class="square "></div>
      <div class="square last"></div>
      </div>
      <div class='loader-text'>This may take a few minutes...</div>
    </div>
  </div>
  <div id="cve-list-view" v-else>
    <ul class='cve-list list-unstyled' v-if='isMitre'>
        <li v-for='item in this.$store.state.mitre' :key='item.id' @click='toggleMitreModal(item)'>
            <div class='item-container'>
                <div class='item-row-flex'>
                    <div class='severity'><div class='severity-score'>{{getMetric(item)}}</div></div>
                    <div class='cve-id'>{{item.id}}</div>
                </div>
                <div class='cve-description'>{{item.description}}</div>
                <div class='item-row-flex'>
                    <div class='cve-modified-date'>Modified: {{fixDate(item.modified)}}</div>
                    <div class='cve-published-date'>Published: {{fixDate(item.published)}}</div>
                </div>
            </div>
        </li>
    </ul>
    <ul class='cve-list list-unstyled' v-else>
        <li v-for='item in this.$store.state.nvd' :key='item.cve.CVE_data_meta.ID' @click='toggleModal(item)'>
            <div class='item-container'>
                <div class='item-row-flex'>
                    <div class='severity'><div class='severity-score'>{{getMetric(item)}}</div></div>
                    <div class='cve-id'>{{item.cve.CVE_data_meta.ID}}</div>
                </div>
                <div class='cve-description'>{{item.cve.description.description_data[0].value}}</div>
                <div class='item-row-flex'>
                    <div class='cve-modified-date'>Modified: {{fixDate(item.lastModifiedDate)}}</div>
                    <div class='cve-published-date'>Published: {{fixDate(item.publishedDate)}}</div>
                </div>
            </div>
        </li>
    </ul>
  </div>
</template>

<script>
import ModalCveInfo from "@/components/ModalCveInfo.vue";
import ModalMitreInfo from "@/components/ModalMitreInfo.vue";

export default {
  name: "cve-list",
  components: {
    // eslint-disable-next-line
    ModalCveInfo
  },
  props: {
      updating: Boolean,
      type: String
  },
  computed: {
      isUpdating() {
          return  this.updating
      },
      isMitre() {
      if (this.type == "mitre") return true;
      else return false;
    }
  },
  methods: {
    toggleModal(item) {
      this.$modal.show(ModalCveInfo, {item},
          { 
            width: 700,
            height: 'auto',
            delay: 100
          }
        );
    },
    toggleMitreModal(item) {
      this.$modal.show(ModalMitreInfo, {item},
          { 
            width: 700,
            height: 'auto',
            delay: 100
          }
        );
    },
    fixDate(date) {
      if (this.type == "mitre") return new Date(date).toLocaleDateString();
      else
        return (new Date(date).toLocaleDateString() + ' ' + new Date(date).toLocaleTimeString())
    },
    getMetric(item) {
      if(this.type == "mitre")
        return '?'
      else{
        if(item.impact.baseMetricV2 != undefined)
            return item.impact.baseMetricV2.cvssV2.baseScore
        else
          return '?'
      }
    }
  }
}
</script>

<style scoped>
.item-container {
    display: flex;
    flex-direction: column;
    align-content: center;
    justify-content: space-between;
    height: 100%;
}

.item-row-flex {
    display: flex;
    flex-direction: row;
    align-items: center;
}

.cve-modified-date, .cve-published-date {
    font-size: 0.9em;
    color: #04aec8;
    margin-right: 50px;
}

.cve-description {
    text-overflow: ellipsis;
    overflow: hidden;
    display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
}

.severity {
  /*background: #34383c;*/
  width: 24px;
  height: 24px;
  border: 1px solid #6a7179;
  display: flex;
  align-items: center;
  justify-content: center;
}

.severity-score {
    font-size: 1em;
    font-weight: 400;
    color: #909ba4;
}

.cve-id {
    font-size: 1.6em;
    font-weight: 400;
    margin-left: 8px;
    color: #909ba4;
}

.list-unstyled {
    list-style: none;
    margin: 0px;
    padding: 0px;
    color: #6a7179;
    font-weight: 500;
    font-size: 0.85em;
}

#cve-list-view {
    margin-right: 6px;
}

.cve-list li {
    background: #2c3034;
    height: 90px;
    margin-top: 12px;    
    border: 1px solid #34383c;
    padding: 6px;
    cursor: pointer;
    user-select: none;
}

.cve-list li:hover {
    background: #34383c;
    border: 1px solid #34383c;
    border-left: 3px solid #04aec8;
    padding-left: 4px;
}

.cve-list li:first-child {
  margin-top: 0 !important;
}

/*** Loader CSS ***/
@-webkit-keyframes enter {
  0% {
    opacity: 0;
    top: -10px;
  }
  5% {
    opacity: 1;
    top: 0px;
  }
  50.9% {
    opacity: 1;
    top: 0px;
  }
  55.9% {
    opacity: 0;
    top: 10px;
  }
}
@keyframes enter {
  0% {
    opacity: 0;
    top: -10px;
  }
  5% {
    opacity: 1;
    top: 0px;
  }
  50.9% {
    opacity: 1;
    top: 0px;
  }
  55.9% {
    opacity: 0;
    top: 10px;
  }
}
@-moz-keyframes enter {
  0% {
    opacity: 0;
    top: -10px;
  }
  5% {
    opacity: 1;
    top: 0px;
  }
  50.9% {
    opacity: 1;
    top: 0px;
  }
  55.9% {
    opacity: 0;
    top: 10px;
  }
}

.loader-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    align-content: center;
    height: calc(100vh - 114px);
}

.loader {
  position: relative;
  margin-bottom: 10px;
}

.loader-text {
  margin-top: 10px;
  color: #6a7179;
  font-weight: 400;
  font-size: 0.95em;
}



.square {
  /*background: #34383c;*/
  width: 15px;
  height: 15px;
  float: left;
  top: -10px;
  margin-right: 5px;
  margin-top: 5px;
  position: relative;
  opacity: 0;
  -webkit-animation: enter 6s infinite;
  animation: enter 6s infinite;
  border: 1px solid #6a7179;
}

.enter {
  top: 0px;
  opacity: 1;
}

.square:nth-child(1) {
  -webkit-animation-delay: 1.8s;
  -moz-animation-delay: 1.8s;
  animation-delay: 1.8s;
}

.square:nth-child(2) {
  -webkit-animation-delay: 2.1s;
  -moz-animation-delay: 2.1s;
  animation-delay: 2.1s;
}

.square:nth-child(3) {
  -webkit-animation-delay: 2.4s;
  -moz-animation-delay: 2.4s;
  animation-delay: 2.4s;
  /*background: #04aec8;*/
  border: 1px solid #04aec8;
}

.square:nth-child(4) {
  -webkit-animation-delay: 0.9s;
  -moz-animation-delay: 0.9s;
  animation-delay: 0.9s;
}

.square:nth-child(5) {
  -webkit-animation-delay: 1.2s;
  -moz-animation-delay: 1.2s;
  animation-delay: 1.2s;
}

.square:nth-child(6) {
  -webkit-animation-delay: 1.5s;
  -moz-animation-delay: 1.5s;
  animation-delay: 1.5s;
}

.square:nth-child(8) {
  -webkit-animation-delay: 0.3s;
  -moz-animation-delay: 0.3s;
  animation-delay: 0.3s;
}

.square:nth-child(9) {
  -webkit-animation-delay: 0.6s;
  -moz-animation-delay: 0.6s;
  animation-delay: 0.6s;
}

.clear {
  clear: both;
}

.last {
  margin-right: 0;
}
</style>
