<template>
  <div id="right" class="column">
    
    <div class="top-right">
      <ViewHeader :title="this.title" :info="this.info" />
    </div>
    <div class="bottom bottom-right" v-if='isCveView'>
      <div class='bottom-wrapper'>
        <div class='watchlist'>
          <div class='watchlist-name'>
            <div class='name-label'>WatchList Name:</div>
            <div class='name'>{{this.watchlist.name}}</div>
          </div>
          <div class='seperator' />
          <div class='cpe-info-cve'>
            <div class='section-name'>
              <div class='btn-list' @click="toggleHardware" :class="{highlight:showHardware}">
                <font-awesome-icon :icon="['fas', 'angle-down']" v-if='showHardware'></font-awesome-icon>
                <font-awesome-icon :icon="['fas', 'angle-right']" v-else></font-awesome-icon>
                Hardware CPEs
              </div>
              <div>
                <ul v-if='showHardware' class='cpe-list-unstyled-normal'>
                  <li v-for="cpe in this.watchlist.cpes[0].hardware" :key='cpe.wfn' :class="{highlight:selected2.includes(cpe.wfn)}">
                    <div @click="selected2.includes(cpe.wfn) ? selected2.splice(selected2.indexOf(cpe.wfn), 1) : selected2.push(cpe.wfn)">
                      <font-awesome-icon :icon="['fas', 'angle-down']" v-if='selected2.includes(cpe.wfn)'></font-awesome-icon>
                      <font-awesome-icon :icon="['fas', 'angle-right']" v-else></font-awesome-icon>
                      {{cpe.name}}
                    </div>
                    <ul v-if='selected2.includes(cpe.wfn)' class='cve-list-unstyled-normal'>
                      <li class='cve-item' v-for="(cve, index) in cpe.cves" :key='index' @click='showCveInfo(cve.split(" : ")[0])'>{{cve}}</li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
            <div class='section-name'>
              <div class='btn-list' @click="toggleApplications" :class="{highlight:showApplications}">
                <font-awesome-icon :icon="['fas', 'angle-down']" v-if='showApplications'></font-awesome-icon>
                <font-awesome-icon :icon="['fas', 'angle-right']" v-else></font-awesome-icon>
                Application CPEs
              </div>
              <div>
                <ul v-if='showApplications' class='cpe-list-unstyled-normal'>
                  <li v-for="cpe in this.watchlist.cpes[0].applications" :key='cpe.wfn' :class="{highlight:selected2.includes(cpe.wfn)}">
                    <div @click="selected2.includes(cpe.wfn) ? selected2.splice(selected2.indexOf(cpe.wfn), 1) : selected2.push(cpe.wfn)">
                      <font-awesome-icon :icon="['fas', 'angle-down']" v-if='selected2.includes(cpe.wfn)'></font-awesome-icon>
                      <font-awesome-icon :icon="['fas', 'angle-right']" v-else></font-awesome-icon>
                      {{cpe.name}}
                    </div>
                    <ul v-if='selected2.includes(cpe.wfn)' class='cve-list-unstyled-normal'>
                      <li class='cve-item' v-for="(cve, index) in cpe.cves" :key='index' @click='showCveInfo(cve.split(" : ")[0])'>{{cve}}</li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
            <div class='section-name'>
              <div class='btn-list' @click="toggleOs" :class="{highlight:showOs}">
                <font-awesome-icon :icon="['fas', 'angle-down']" v-if='showOs'></font-awesome-icon>
                <font-awesome-icon :icon="['fas', 'angle-right']" v-else></font-awesome-icon>
                OS CPEs
              </div>
              <div>
                <ul v-if='showOs' class='cpe-list-unstyled-normal'>
                  <li v-for="cpe in this.watchlist.cpes[0].os" :key='cpe.wfn' :class="{highlight:selected2.includes(cpe.wfn)}">
                    <div @click="selected2.includes(cpe.wfn) ? selected2.splice(selected2.indexOf(cpe.wfn), 1) : selected2.push(cpe.wfn)">
                      <font-awesome-icon :icon="['fas', 'angle-down']" v-if='selected2.includes(cpe.wfn)'></font-awesome-icon>
                      <font-awesome-icon :icon="['fas', 'angle-right']" v-else></font-awesome-icon>
                      {{cpe.name}}
                    </div>
                    <ul v-if='selected2.includes(cpe.wfn)' class='cve-list-unstyled-normal'>
                      <li class='cve-item' v-for="(cve, index) in cpe.cves" :key='index' @click='showCveInfo(cve.split(" : ")[0])'>{{cve}}</li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="bottom bottom-right" v-else>
      <div class='bottom-wrapper'>
        <div class='menu'>
          <div class='btn-edit' @click="savingWatchlist()">
            <font-awesome-icon :icon="['far', 'check-square']"></font-awesome-icon>Save
          </div>
        </div>
        <div class='watchlist'>
          <div class='watchlist-name'>
            <div class='name-label'>WatchList Name: </div>
            <input class='name-edit' type="text" v-model="watchlist.name" required @blur="cancelNameEdit()" @keyup.enter="nameEdit()"
              @keyup.esc="cancelNameEdit()" ref="nameInput" />
          </div>
          <div class='seperator' />
          <div class='cpe-info'>
            <div class='section-header'>
              CPEs Selected:
            </div>
            <div class='section-name'>
              <div class='btn-list' @click="toggleHardware">
                <font-awesome-icon :icon="['fas', 'angle-down']" v-if='showHardware'></font-awesome-icon>
                <font-awesome-icon :icon="['fas', 'angle-right']" v-else></font-awesome-icon>
                Hardware CPEs
              </div>
              <div class='current-cpes'>
                <ul v-if='showHardware' class='cpe-list-unstyled'>
                  <li class='cpe-item' v-for="(cpe, index) in this.watchlist.cpes[0].hardware" :key='cpe.wfn' @click="removeCpe(index,'hardware')">
                    <font-awesome-icon :icon="['far', 'minus-square']"></font-awesome-icon>{{cpe.name}}
                  </li>
                </ul>
              </div>
            </div>
            <div class='section-name'>
              <div class='btn-list' @click="toggleApplications">
                <font-awesome-icon :icon="['fas', 'angle-down']" v-if='showApplications'></font-awesome-icon>
                <font-awesome-icon :icon="['fas', 'angle-right']" v-else></font-awesome-icon>
                Application CPEs
              </div>
              <div class='current-cpes'>
                <ul v-if='showApplications' class='cpe-list-unstyled'>
                  <li class='cpe-item' v-for="(cpe, index) in this.watchlist.cpes[0].applications" :key='cpe.wfn'
                    @click="removeCpe(index,'application')">
                    <font-awesome-icon :icon="['far', 'minus-square']"></font-awesome-icon>{{cpe.name}}
                  </li>
                </ul>
              </div>
            </div>
            <div class='section-name'>
              <div class='btn-list' @click="toggleOs">
                <font-awesome-icon :icon="['fas', 'angle-down']" v-if='showOs'></font-awesome-icon>
                <font-awesome-icon :icon="['fas', 'angle-right']" v-else></font-awesome-icon>
                OS CPEs
              </div>
              <div class='current-cpes'>
                <ul v-if='showOs' class='cpe-list-unstyled'>
                  <li class='cpe-item' v-for="(cpe, index) in this.watchlist.cpes[0].os" :key='cpe.wfn' @click="removeCpe(index,'os')">
                    <font-awesome-icon :icon="['far', 'minus-square']"></font-awesome-icon>{{cpe.name}}
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <div class='seperator' />
          <div class='cpe-search'>
            <div class='flex-search'>
              <div class='search-label'>Add a CPE from the dictionary:</div>
              <input type="text" class="search-input name-edit" v-debounce:2000ms="searchCpe" v-model="searchQuery"
                placeholder="Type a product keyword here..." />
            </div>
            <div class='cpe-results'>
              <ul class="list-unstyled">
                <li v-for="item in searchResult" :key="item.wfn" @click='addCpe(item)'>
                  <font-awesome-icon :icon="['far', 'plus-square']"></font-awesome-icon>{{item.name}}
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
  // @ is an alias to /src
  import ViewHeader from "@/components/ViewHeader.vue"
  import ModalCveInfo from "@/components/ModalCveInfo.vue"
 
  const {
    ipcRenderer
  } = require('electron')
  // TODO: Fix search label color
  // get cpe's displaying in cpe-info
  // properly add cpe array
  // sort cpe during add
  // mark selected in results based on current cpe (compare returned result item to current cpes and set selected class.)[stopping dupes]
  // get watchlist reporting cpe numbers?cve numbers?
  // trigger cpe scrape on save and lock list from being edited while updating.
  // show cve's by tree dropdown? on inspection not edit? both?
  export default {
    name: 'inspect-watchlist',
    components: {
      ViewHeader,
      // eslint-disable-next-line
      ModalCveInfo
    },
    props: {
      test: Object,
      title: String,
      info: String,
      type: String,
      
    },
    data() {
      return {
        editing: false,
        saved: true,
        namecache: '',
        watchlist_cache: {
          id: '',
          name: '',
          cpes: [{
            hardware: [],
            applications: [],
            os: []
          }],
          isUpdating: false
        },
        index: null,
        watchlist: {
          id: '',
          name: '',
          cpes: [{
            hardware: [],
            applications: [],
            os: []
          }],
          isUpdating: false
        },
        searchQuery: '',
        searchResult: [],
        toggledHardware: false,
        toggledApplications: false,
        toggledOs: false,
        selected2: [],
        selected: undefined
      }
    },
    computed: {
      isSaved() {
        if(this.saved == true)
          return true
        else
          return false
      },
      isCveView() {
        if (this.type === 'cve')
          return true
        else
          return false
      },
      hasCpe() {
        if (this.watchlist.cpes.length == 0)
          return true
        else
          return true
      },
      hasHardware() {
        if (this.watchlist.cpes[0].hardware.length == 0)
          return false
        else
          return true
      },
      hasApplications() {
        if (this.watchlist.cpes[0].applications.length == 0)
          return false
        else
          return true
      },
      hasOs() {
        if (this.watchlist.cpes[0].os.length == 0)
          return false
        else
          return true
      },
      showHardware() {
        if (this.toggledHardware)
          return true
        else
          return false
      },
      showApplications() {
        if (this.toggledApplications)
          return true
        else
          return false
      },
      showOs() {
        if (this.toggledOs)
          return true
        else
          return false
      }
    },
    mounted() {
      if (this.test != null) {
        this.watchlist = JSON.parse(JSON.stringify(this.test.item))
        this.namecache = this.watchlist.name
        this.watchlist_cache = JSON.parse(JSON.stringify(this.test.item))
        this.index = this.test.index
      }
      this.$root.$on('res-info-for-modal', (arg) => {
        this.toggleModal(arg)
      })
      
      
    },
    
    methods: {
      toggleModal(item) {
        
        this.$modal.show(ModalCveInfo, {item},
        { 
          width: 700,
          height: 'auto',
          delay: 100
          }
        );
      },
      showCveInfo(cveId) {
        //console.log(cveId)
        ipcRenderer.send('getCveInfoFromGit', cveId)
      },
      savingWatchlist() {
        this.watchlist.isUpdating = !this.watchlist.isUpdating
        this.$store.dispatch('replaceWatchList', {
          index: this.index,
          watchlist: this.watchlist
        })
        this.saveWatchLists()
        this.updateWatchlistCve()
        this.toggleEditing()
        this.saved = true
        this.$router.push({
          name: 'watch-lists'
        })
      },
      updateWatchlistCve() {
        ipcRenderer.send('req-update-watchlist', {
          index: this.index,
          watchlist: this.watchlist
        })
      },
      saveWatchLists() {
        ipcRenderer.send('save-local-watchlist', this.$store.state.watchLists)
      },
      removeCpe(index, type) {
        if (type == 'hardware')
          this.watchlist.cpes[0].hardware.splice(index, 1)
        else if (type == 'application')
          this.watchlist.cpes[0].applications.splice(index, 1)
        else if (type == 'os')
          this.watchlist.cpes[0].os.splice(index, 1)

        this.saved = false
      },
      toggleHardware() {
        this.toggledHardware = !this.toggledHardware
      },
      toggleApplications() {
        this.toggledApplications = !this.toggledApplications
      },
      toggleOs() {
        this.toggledOs = !this.toggledOs
      },
      addCpe(cpe) {
        this.saved = false
        console.log(cpe)
        // add cve-id array
        cpe.cves = []


        var str = cpe.wfn
        var _t = str.split(':')

        if (_t[2] == 'h')
          this.watchlist.cpes[0].hardware.push(cpe)

        else if (_t[2] == 'a')
          this.watchlist.cpes[0].applications.push(cpe)

        else if (_t[2] == 'o')
          this.watchlist.cpes[0].os.push(cpe)

      },
      toggleEditing() {
        this.editing = !this.editing
      },
      toggleLoading() {
        this.isLoading = !this.isLoading
      },
      nameEdit() {
        
        if (this.watchlist.name.trim() == '' || this.watchlist.name === this.namecache)
          this.watchlist.name = this.namecache
        else
        {
          this.saved = false
          this.namecache = this.watchlist.name
        }

        this.$refs.nameInput.blur()
      },
      cancelNameEdit() {
        this.watchlist.name = this.namecache
        this.$refs.nameInput.blur()
      },
      searchCpe: function () {

        if (this.searchQuery.trim() == '')
          this.searchResult = []
        else {
          this.searchResult = this.$store.state.cpes.filter((item) => {
            return item.name.toLowerCase().match(this.searchQuery.toLowerCase())
          })
          console.log(this.searchResult)
        }
      }
    },
    beforeRouteLeave (to, from, next) {
      if(this.isSaved == false) {
        var answer = window.confirm('Do you really want to leave? you have unsaved changes!')
        if (answer) {
          
          this.watchlist = JSON.parse(JSON.stringify(this.watchlist_cache))
          
          console.log(this.watchlist)
          console.log(this.watchlist_cache)
          this.$root.$off('res-info-for-modal', next())
          //next()
        } else {
          console.log(this.watchlist)
          next(false)
        }
      }
      else{
        console.log(this.watchlist)
        this.$root.$off('res-info-for-modal', next())
        //next()
      }
        
    }
  }
</script>

<style scoped>
  .flex-search {
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    flex-grow: 0;
    align-items: center;
    margin-bottom: 6px;
    color: #909ba4;
  }

  .list-unstyled {
    list-style: none;
    margin: 0px;
    padding: 0px;
    color: #6a7179;
    font-weight: 500;
    font-size: 0.80em;
    width: calc(100% - 6px);
    user-select: none;
    background-color: #202428;
  }

  .list-unstyled li:hover {
    color: #04aec8;
  }

  .list-unstyled li {
    padding: 6px 6px 0px 0px;
  }

  .list-unstyled li svg {
    width: 24px;
  }

  .cpe-search {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }

  .cpe-results {
    flex-grow: 1;
    overflow-y: auto;
    overflow-x: hidden;
    background-color: inherit;
    width: 100%;
    margin-right: 12px;
  }

  .search-input {
    margin: 6px 0px;
  }

  .cpe-results::-webkit-scrollbar {
    width: 6px;
    background-color: #1a1d20;
  }

  .cpe-results::-webkit-scrollbar-thumb {
    background-color: #04aec8;
  }

  .cpe-results::-webkit-scrollbar-track {
    -webkit-box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.4);
    background-color: #1a1d20;
  }

  .cpe-item {
    padding: 6px 0px 0px 0px;
  }

  .cpe-item svg {
    width: 24px;
  }

  .cpe-item:hover {
    color: #04aec8;
  }

  .cpe-item:last-child {
    padding-bottom: 6px;
  }

  .current-cpes {
    overflow-y: auto;
    max-height: 15vh;
  }

  .current-cpes::-webkit-scrollbar {
    width: 6px;
    background-color: #1a1d20;
  }

  .current-cpes::-webkit-scrollbar-thumb {
    background-color: #04aec8;
  }

  .current-cpes::-webkit-scrollbar-track {
    -webkit-box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.4);
    background-color: #1a1d20;
  }

  .cpe-info {
    flex-grow: 0;
  }

  .cpe-list-unstyled {
    list-style: none;
    margin: 0px;
    padding: 0px;
    color: #6a7179;
    width: calc(100% - 6px);
    user-select: none;
    background-color: #202428;
  }

  .section-header {
    margin-bottom: 9px;
    font-weight: 600;
    color: #909ba4;
  }

  .name-edit:invalid {
    box-shadow: 0 0 5px 1px #04aec8;
  }

  .name-edit:focus:invalid {
    outline: none;
  }

  .name-edit:focus,
  textarea:focus {
    outline: 1px solid #04aec8;
  }

  .name-edit {
    margin-left: 6px;
    background-color: #202428;
    border: none;
    border-radius: 0px;
    font-family: "Montserrat", sans-serif;
    font-size: 1em;
    font-weight: 600;
    color: #909ba4;
    padding: 6px;
    width: 50%;
  }

  .menu {
    background-color: inherit;
    margin-bottom: 12px;
  }

  li.cve-item:hover {
    color: #04aec8;
  }

  .cve-list-unstyled-normal li.cve-item {
    margin-left: 18px;
    text-overflow: ellipsis;
    overflow: hidden;
    display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
  }

  .cve-list-unstyled-normal {
    list-style: none;
    margin: 0px;
    padding: 0px;
    width: calc(100% - 6px);
    user-select: none;
    margin-top: 6px;
  }

  .cpe-list-unstyled-normal li.highlight div,
  .cpe-list-unstyled-normal li.highlight div svg {
    color: #04aec8;
  }

  .cpe-list-unstyled-normal li div:hover {
    color: #04aec8;
  }

  .cpe-list-unstyled-normal li div svg {
    width: 12px;
  }

  .cpe-list-unstyled-normal li div {
    cursor: pointer;
  }

  .cpe-list-unstyled-normal li {
    margin-left: 12px;
    margin-bottom: 6px;
  }

  .cpe-list-unstyled-normal {
    list-style: none;
    margin: 0px;
    padding: 0px;
    width: calc(100% - 6px);
    user-select: none;
  }

  .btn-list:hover,
  .btn-list.highlight {

    color: #04aec8;
  }

  .btn-list svg {
    width: 12px;
  }

  .btn-list {
    cursor: pointer;
    padding: 6px 0px;
  }

  .section-name {
    font-size: .8em;
    font-weight: 400;
    color: #909ba4;
    margin-left: 6px;
  }

  .cpe-info-cve {
    flex-grow: 0;
    overflow-y: auto;
  }

  .cpe-info-cve::-webkit-scrollbar {
    width: 6px;
    background-color: #1a1d20;
  }

  .cpe-info-cve::-webkit-scrollbar-thumb {
    background-color: #04aec8;
  }

  .cpe-info-cve::-webkit-scrollbar-track {
    -webkit-box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.4);
    background-color: #1a1d20;
  }

  .seperator {
    display: block;
    margin-top: 12px;
    margin-bottom: 12px;
    margin-left: 0px;
    margin-right: auto;
    border-top: 1px solid #34383c;
    width: calc(100% - 6px);
    flex-grow: 0;
    flex-shrink: 0;
  }

  .name {
    margin-left: 6px;
    padding: 6px;
  }

  .name-label,
  .name {
    font-size: 1em;
    font-weight: 600;
    color: #909ba4;
  }

  .watchlist-name {
    display: flex;
    flex-shrink: 0;
    flex-grow: 0;
    flex-direction: row;
    align-items: center;
  }

  .watchlist {
    display: flex;
    flex-direction: column;
    padding: 12px;
    padding-right: 6px;
    height: 100%;
    background: #2c3034;
    border: 1px solid #34383c;
  }

  .bottom-wrapper {
    display: flex;
    flex-direction: column;
    position: absolute;
    top: 103px;
    left: 103px;
    bottom: 12px;
    width: calc(100% - 115px);
  }

  .btn-edit:hover svg,
  .btn-save:hover svg {
    color: #04aec8 !important;
  }

  .btn-edit:hover,
  .btn-save:hover {
    background: #34383c;
    color: #909ba4 !important;
  }

  .btn-edit svg,
  .btn-save svg {
    margin-right: 6px;
  }

  .btn-edit,
  .btn-save {
    height: 36px;
    display: flex;
    flex-direction: row;
    align-items: center;
    align-content: center;
    justify-content: center;
    flex-grow: 1;
    flex-shrink: 0;
    cursor: pointer;
    color: #6a7179;
    font-weight: 500;
    font-size: 0.85em;
    user-select: none;
  }
</style>